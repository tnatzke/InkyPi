#!/usr/bin/env bash
set -e

PLUGINS_DIR="$PROJECT_DIR/src/plugins"

command="${1:-}"
shift || true

usage() {
    echo ""
    echo "Plugin commands:"
    echo "  inkypi plugin install <plugin_id> <git_repository_url>"
    echo "  inkypi plugin remove <plugin_id>"
    echo "  inkypi plugin list"
    echo ""
}

require_plugins_dir() {
    if [[ ! -d "$PLUGINS_DIR" ]]; then
        echo "Plugins directory does not exist: $PLUGINS_DIR"
        exit 1
    fi
}

# ----------------------------
# INSTALL
# ----------------------------
install_plugin() {
    if [[ $# -ne 2 ]]; then
        usage
        exit 1
    fi

    PLUGIN_ID="$1"
    REPO_URL="$2"
    DEST_DIR="$PLUGINS_DIR/$PLUGIN_ID"

    require_plugins_dir

    # Workaround for .pyc files created by inkypi app with sudo
    if [[ -d "$DEST_DIR" ]]; then
        sudo chown -R "$(whoami)":"$(whoami)" "$DEST_DIR" 2>/dev/null || true
        chmod -R u+rw "$DEST_DIR" 2>/dev/null || true
    fi

    echo "[INFO] Installing plugin '$PLUGIN_ID' from $REPO_URL"

    rm -rf "$DEST_DIR"
    mkdir -p "$DEST_DIR"

    git clone --depth 1 --filter=blob:none --sparse "$REPO_URL" "$DEST_DIR" &>/dev/null

    # Check if the folder exists in the branch
    DEFAULT_BRANCH=$(git -C "$DEST_DIR" symbolic-ref --short HEAD 2>/dev/null || echo main)
    if ! git -C "$DEST_DIR" ls-tree --name-only "$DEFAULT_BRANCH" | grep -qx "$PLUGIN_ID"; then
        echo "[INFO] Plugin '$PLUGIN_ID' does not exist in the repo"
        rm -rf "$DEST_DIR"
        exit 1
    fi

    cd "$DEST_DIR"
    git sparse-checkout set "$PLUGIN_ID" &>/dev/null

    # Move plugin files to root of DEST_DIR
    shopt -s dotglob
    mv "$PLUGIN_ID"/* ./
    rm -rf "$PLUGIN_ID"

    echo "[INFO] Plugin copied to $DEST_DIR"

    # Install requirements if any
    REQ_FILE="$DEST_DIR/requirements.txt"

    if [[ -f "$REQ_FILE" ]]; then
        echo "[INFO] requirements.txt found, installing dependencies..."

        if [[ ! -d "$VENV_PATH" ]]; then
            echo "[ERROR] Virtual environment not found at $VENV_PATH"
            exit 1
        fi

        source "$VENV_PATH/bin/activate"
        pip install -r "$REQ_FILE"
        deactivate

        echo "[INFO] Dependencies installed"
    else
        echo "[INFO] No requirements.txt found, skipping dependency install"
    fi

    echo "[INFO] Restarting $APPNAME service."
    sudo systemctl restart "$APPNAME.service"

    echo "[INFO] Done"
}

# ----------------------------
# REMOVE
# ----------------------------
uninstall_plugin() {
    if [[ $# -ne 1 ]]; then
        usage
        exit 1
    fi

    PLUGIN_ID="$1"
    DEST_DIR="$PLUGINS_DIR/$PLUGIN_ID"

    require_plugins_dir

    if [[ ! -d "$DEST_DIR" ]]; then
        echo "[ERROR] Plugin '$PLUGIN_ID' is not installed."
        exit 1
    fi

    echo "[INFO] Removing plugin '$PLUGIN_ID'"

    sudo chown -R "$(whoami)":"$(whoami)" "$DEST_DIR" 2>/dev/null || true
    rm -rf "$DEST_DIR"

    echo "[INFO] Plugin successfully uninstalled"

    echo "[INFO] Restarting $APPNAME service."
    sudo systemctl restart "$APPNAME.service"
}

# ----------------------------
# LIST
# ----------------------------
list_plugins() {
    require_plugins_dir
    {
        printf "PLUGIN\tNAME\tTYPE\tREPOSITORY\n"

        for plugin_dir in "$PLUGINS_DIR"/*; do
            plugin_id="$(basename "$plugin_dir")"
            [[ "$plugin_id" == "base_plugin" ]] && continue

            info_file="$plugin_dir/plugin-info.json"
            [[ ! -f "$info_file" ]] && continue

            # Extract name + repository
            IFS=$'\t' read -r name repo < <(
                jq -r '[.display_name, .repository] | map(. // "") | @tsv' "$info_file"
            )

            # Infer type from repository presence
            if [[ -n "$repo" ]]; then
                type="third_party"
            else
                type="builtin"
                repo="-"
            fi

            printf "%s\t%s\t%s\t%s\n" \
                "$plugin_id" "$name" "$type" "$repo"
        done
    } | column -t -s $'\t'
}
# ----------------------------
# COMMAND ROUTER
# ----------------------------

case "$command" in
    install)
        install_plugin "$@"
        ;;
    uninstall)
        uninstall_plugin "$@"
        ;;
    list)
        list_plugins
        ;;
    ""|-h|--help|help)
        usage
        ;;
    *)
        echo "[ERROR] Unknown command: $command"
        usage
        exit 1
        ;;
esac
